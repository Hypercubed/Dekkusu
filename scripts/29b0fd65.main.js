!function(){var a=angular.module("mainApp",["ui.router","ui.bootstrap","ui.keypress","ui.event","ngSanitize","firebase","ngAnimate"]);a.constant("FBURL","https://dekkusu.firebaseio.com/").constant("DEBUG",!1).constant("SITE",{title:"Dekkusu",company:"J. Harshbarger",year:"2013"}),a.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),b.rule(function(a,b){var c,d=b.path(),e=b.search();if("/"===d[d.length-1])return 0===Object.keys(e).length?d.slice(0,d.length-1):(c=[],angular.forEach(e,function(a,b){c.push(b+"="+a)}),d+"?"+c.join("&"))}),a.state("home",{url:"/",templateUrl:"partials/homeView.html",controller:"HomeCtrl"}).state("user",{"abstract":!0,url:"/:username",templateUrl:"partials/userView.html",controller:"userViewCtrl"}).state("user.deckList",{url:"",templateUrl:"partials/user.deckList.html",controller:"DeckListCtrl"}).state("user.deck",{"abstract":!0,url:"/:deck",templateUrl:"partials/user.deckView.html",controller:"DeckCtrl"}).state("user.deck.cardList",{url:"",templateUrl:"partials/user.deck.cardList.html",controller:"DeckCtrl"}).state("user.deck.card",{url:"/:id",templateUrl:"partials/user.deck.cardView.html",controller:"cardViewCtrl"})}]),a.config(["$logProvider","DEBUG",function(a,b){a.debugEnabled(b)}]),a.run(["$firebaseAuth","FBURL","$rootScope","DEBUG","$log","$location",function(a,b,c){var d=new Firebase(b);c.auth=a(d)}]),a.run(["$rootScope","SITE",function(a,b){a.site=b}])}();var DEBUG=!1,DAYS=864e5;angular.module("mainApp").controller("DeckListCtrl",["$scope","$location","$http","$stateParams","$rootScope",function(){}]),angular.module("mainApp").controller("DeckCtrl2",["$scope","$http",function(a,b){a.clearCards=function(){a.deck.cards=[{text:""}]},a.resetCards=function(){b.get("data/first30.txt").success(function(b){var c=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});a.deck.cards=c})}}]),angular.module("mainApp").controller("DeckCtrl",["$state","$scope","$location","$http","$stateParams","$rootScope","statusFilterFilter","$firebase","FBURL","deckManager",function(a,b,c,d,e,f,g,h,i,j){function k(){var a=b.cardIds=b.cards.$getIndex();b.stats={"new":0,due:0,done:0,total:a.length}}function l(){}b.username=e.username||"default",f.deckId=b.deckId=e.deck||0,b.decks=[],b.deck={cards:[]},b.search=c.search(),b.filter=STATUSALL,b.isEditing=!1;var m=new Firebase(i).child("decks");m.child(e.deck).child("cards"),b.decks=j.getUserDeckIds(b.username),b.cards=j.getDeckById(b.deckId),b.cards.$on("loaded",k),b.cards.$on("change",k),b.copyCards=function(){var a=b.deck,d=b.user.username,e=d+"/"+a.id;new Firebase(i).child("decks/"+e).set(a),c.path("/"+e)},b.editDeck=function(a){b.isEditing=arguments.length>0?a:!b.isEditing},b.gotoDeck=function(a){c.path("/"+b.username+"/"+a)},b.resetCards=function(){d.get("data/first30.txt").success(function(a){var c=a.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});refCards.remove(),c.forEach(function(a){b.cards.add(a)}),l()})},b.clearCards=function(){b.cards=[{text:""}]},b.goto=function(a){"object"==typeof a&&(a=b.cards.indexOf(a)),a>b.cards.length&&(a=b.cards.length),0>a&&(b.index=0),b.index=a},b.keypressCallback=function(a){console.log(a.keyCode),32==a.keyCode?(b.flip(),a.preventDefault()):13==a.keyCode?b.edit():37==a.keyCode?b.prev():39==a.keyCode?b.next():38!=a.keyCode||b.clozed?40!=a.keyCode||b.clozed||b.down():b.up()},b.prev=function(){var a=b.index>0?b.index:b.cards.length;b.goto(a-1)},b.next=function(){var a=b.index<b.cards.length-1?b.index+1:0;b.goto(a)},b.deleteCard=function(){var a=b.deck.cards.indexOf(b.card);b.deck.cards.splice(a,1),b.goto(b.index)},angular.element(".cardEditor")[0]}]),angular.module("mainApp").filter("formatCard",["$sanitize",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rp>&#91;</rp><rt>$2</rt><rp>&#93;</rp></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{(.*?)::(.*?)}",replace:'{$1}<span class="uncloze">$2</span>'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=function(){return[{type:"lang",regex:"\n{1,}",replace:"\n\n"}]},e=new Showdown.converter({extensions:[d,b,c]});return function(b){return a(e.makeHtml(b||""))}}]),angular.module("mainApp").filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),angular.module("mainApp").filter("dueNow",function(){return function(a){var b=Date.now();return a.filter(function(a){return a.due<b})}}),angular.module("mainApp").filter("dateDays",function(){var a=Date.now();return function(b){if(!b)return"-";var c=b-a;return 0>c?"now":(c=c/1e3/60,1>c?"soon":(c=c/60/24,1>c?"<1 day":Math.floor(c)+" days"))}}),angular.module("mainApp").filter("markdown",[function(){var a=new Showdown.converter;return function(b){return a.makeHtml(b||"")}}]);var STATUSALL=-1,STATUSNEW=0,STATUSDUE=1,STATUSDONE=2;angular.module("mainApp").filter("status",[function(){var a=Date.now();return function(b){return b?null==b.last?STATUSNEW:b.due<=a?STATUSDUE:STATUSDONE:-1}}]),angular.module("mainApp").filter("statusText",[function(){return function(a){return a==STATUSNEW?"New":a==STATUSDUE?"Due":"Not due"}}]),angular.module("mainApp").filter("statusFilter",["$filter",function(a){var b=a("status");return function(a,c){return-1==c?a:a.filter(function(a){return b(a)==c})}}]),angular.module("mainApp").service("deckManager",["FBURL","$firebase",function(a,b){var c=new Firebase(a),d=c.child("decks"),e=c.child("sets");this.getUserDeckIds=function(a){var c=e.child(a).child("decks");return b(c)},this.getDeckById=function(a){var c=d.child(a).child("cards");return b(c)},this.addDeck=function(a){var b=d.push();b.set({owner:a}),e.child(a).child("decks").child(b.name()).set(!0)},this.removeDeck=function(a,b){d.child(b).remove(),e.child(a).child("decks").child(b).remove()}}]),angular.module("mainApp").directive("cardView",[function(){return{scope:{card:"=",cards:"=",isOwner:"=",ngClass:"=",listview:"="},templateUrl:"partials/cardView.html",link:function(a){function b(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=c.selectionStart,d=c.selectionEnd;if(b!==d)return c.value.slice(b,d).trim()}return null}a.isEditing=!1,a.clozed=!0,console.log(a);var c=angular.element(".cardEditor")[0];a.wrap=function(b,d){window.getSelection();var e=c.selectionStart,f=c.selectionEnd,g=a.card.text;a.card.text=g.slice(0,e)+b+g.slice(e,f)+d+g.slice(f),setTimeout(function(){c.selectionStart=e+b.length,c.selectionEnd=f+b.length},100)},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b,b||a.cards.$save(a.card.$id)},a.flip=function(){a.clozed=!a.clozed},a.up=function(){a.card.last=Date.now(),a.card.due-a.card.last<=0&&(a.card.interval=a.card.interval>0?2*a.card.interval:1),a.card.due=a.card.last+a.card.interval*DAYS,a.cards.update(card),a.clozed=!0},a.down=function(){a.card.due=a.card.last=Date.now()-5,a.card.interval=0,a.cards.update(card),a.clozed=!0},a.add=function(){var c=b(),d={};d.text=c||"",d.due=d.due||Date.now(),d.interval=d.interval||0,a.cards.add(d),a.edit(!0)}}}}]),angular.module("mainApp").directive("cardBlur",function(){return function(a,b,c){b.bind("blur",function(b){b.relatedTarget||a.$apply(c.cardBlur)})}}),angular.module("mainApp").controller("HomeCtrl",["$scope","$rootScope","$location",function(a){a.$on("$firebaseAuth:login",function(){}),a.$on("$firebaseAuth:logout",function(){}),a.$on("$firebaseAuth:error",function(a,b){console.log(b)})}]),angular.module("mainApp").controller("userViewCtrl",["$scope","$rootScope","$location","$http","$stateParams","$rootScope","$firebase","FBURL","$state","deckManager",function(a,b,c,d,e,b,f,g,h,i){function j(){a.isOwner=b.auth.user?b.auth.user.username==a.username:"guest"==a.username,console.log("setAuth",a.isOwner,b.auth.user,b.username)}a.username=e.username||"guest",a.deckId=h.params.deck||null,a.decks=[],a.listView=!1,b.$on("$stateChangeSuccess",function(){a.deckId=h.params.deck||null}),a.decks=i.getUserDeckIds(a.username),a.addDeck=function(){i.addDeck(a.username)},a.removeDeck=function(b){i.removeDeck(a.username,b)},j(),b.$on("$firebaseAuth:login",function(a,b){console.log("User "+b.id+" successfully logged in!"),j()}),a.$on("$firebaseAuth:logout",function(){j()}),a.$on("$firebaseAuth:error",function(){j()})}]),angular.module("mainApp").controller("cardViewCtrl",["$scope","$location","$http","$stateParams","$rootScope","statusFilterFilter",function(a){function b(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=c.selectionStart,d=c.selectionEnd;if(b!==d)return c.value.slice(b,d).trim()}return null}a.index=0,console.log("cardViewCtrl $scope",a),a.goto=function(b){console.log(b),b>a.$parent.cardIds.length&&(b=0),0>b&&(b=a.$parent.cardIds.length),a.index=b},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.prev=function(){a.goto(a.index-1)},a.next=function(){a.goto(a.index+1)},a.add=function(){var c=b(),d={};d.text=c||"",d.due=d.due||Date.now(),d.interval=d.interval||0,a.cards.add(d),a.goto(d),a.isEditing=!0},a.deleteCard=function(){var b=a.deck.cards.indexOf(a.card);a.deck.cards.splice(b,1),a.goto(a.index)};var c=angular.element(".cardEditor")[0]}]);