"use strict";var DEBUG=!1,DAYS=864e5,app=angular.module("mainApp",["ngRoute","ui.bootstrap","ui.keypress","ui.event","ngSanitize","firebase"]);angular.module("mainApp").config(["$routeProvider",function(a){console.log(a),a.when("/",{templateUrl:"partials/homeView.html",controller:"HomeCtrl"}).when("/:username",{templateUrl:"partials/deckListView.html",controller:"DeckListCtrl"}).when("/:username/:deck",{templateUrl:"partials/deckView.html",controller:"DeckCtrl"}).otherwise({redirectTo:"/guest"})}]),app.controller("NavCtrl",["$scope","angularFireAuth",function(a,b){a.collapse=!0;var c=new Firebase("https://dekkusu.firebaseio.com/");b.initialize(c,{scope:a,name:"user"}),a.login=function(){b.login("github")},a.logout=function(){b.logout()}}]),angular.module("mainApp").controller("HomeCtrl",["$scope","angularFireAuth","$location",function(a,b,c){a.login=function(){b.login("github")},a.$on("angularFireAuth:login",function(a,b){c.path("/"+b.username)}),a.$on("angularFireAuth:logout",function(){c.path("/")}),a.$on("angularFireAuth:error",function(){})}]),angular.module("mainApp").controller("DeckListCtrl",["$scope","$location","$http","$routeParams","$rootScope","angularFire","angularFireCollection",function(a,b,c,d,e,f){a.username=d.username||"default",a.decks=[],a.listView=!1;var g=new Firebase("https://dekkusu.firebaseio.com/decks/"+a.username);f(g,a,"decks"),a.addDeck=function(){for(var b="Deck",c="deck",d=1;a.decks[c];)d++,b="Deck "+d,c="deck-"+d;var e=[{text:""}],f={id:c,name:b,cards:e};g.child(c).set(f)},a.removeDeck=function(a){g.child(a).set(null)}}]),angular.module("mainApp").controller("DeckCtrl2",["$scope","$http",function(a,b){a.clearCards=function(){a.deck.cards=[{text:""}]},a.resetCards=function(){b.get("data/first30.txt").success(function(b){var c=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});a.deck.cards=c})}}]),angular.module("mainApp").controller("DeckCtrl",["$scope","$location","$http","$routeParams","$rootScope","statusFilterFilter","angularFire",function(a,b,c,d,e,f,g){function h(){a.filter=STATUSDUE,a.isEditing=!1,i()}function i(){a.index=0,a.applyFilter(a.filter)}a.username=d.username||"default",a.deckId=d.deck||0,a.decks=[],a.deck={cards:[]},a.search=b.search();var j=new Firebase("https://dekkusu.firebaseio.com/decks/"+a.username),k=j.child(d.deck);g(j,a,"decks"),g(k,a,"deck"),a.editDeck=function(b){a.isEditing=arguments.length>0?b:!a.isEditing},a.gotoDeck=function(c){b.path("/"+a.username+"/"+c)},a.resetCards=function(){c.get("data/first30.txt").success(function(b){var c=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});a.deck.cards=c,i()})},a.clearCards=function(){a.deck.cards=[{text:""}],i()},a.applyFilter=function(b){a.filter=b=b||a.filter,a.filteredCards=f(a.deck.cards,a.filter).sort(function(a,b){return a.due<b.due?-1:a.due>b.due?1:0}),a.goto(a.index)},a.goto=function(b){"object"==typeof b&&(b=a.filteredCards.indexOf(b)),b>a.filteredCards.length&&(b=a.filteredCards.length),0>b&&(a.index=0),a.index=b,a.card=a.filteredCards[a.index]},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.prev=function(){var b=a.index>0?a.index:a.filteredCards.length;a.goto(b-1)},a.next=function(){var b=a.index<a.filteredCards.length-1?a.index+1:0;a.goto(b)},a.add=function(){var b="",c={};c.text=b||"",c.due=c.due||Date.now(),c.interval=c.interval||0,a.deck.cards.push(c),a.filteredCards=a.deck.cards,a.goto(c),a.isEditing=!0},a.deleteCard=function(){var b=a.deck.cards.indexOf(a.card);a.deck.cards.splice(b,1),a.goto(a.index)},h(),a.$watch("filter",function(b,c){b!=c&&a.applyFilter(b)})}]),angular.module("mainApp").controller("CardCtrl",["$scope",function(a){function b(){a.isEditing=!1,a.clozed=!0}var c=angular.element(".cardEditor")[0];b(),a.wrap=function(b,d){window.getSelection();var e=c.selectionStart,f=c.selectionEnd,g=a.card.text;a.card.text=g.slice(0,e)+b+g.slice(e,f)+d+g.slice(f),setTimeout(function(){c.selectionStart=e+b.length,c.selectionEnd=f+b.length},100)},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.flip=function(){a.clozed=!a.clozed},a.up=function(){a.card.last=Date.now(),a.card.due-a.card.last<=0&&(a.card.interval=a.card.interval>0?2*a.card.interval:1),a.card.due=a.card.last+a.card.interval*DAYS,a.clozed=!0,a.applyFilter()},a.down=function(){a.card.due=a.card.last=Date.now()-5,a.card.interval=0,a.clozed=!0,a.applyFilter()},a.$watch("card.text",function(a,b){a==b}),a.$watch("card.due",function(a,b){a==b})}]),app.filter("formatCard",["$sanitize",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rp>&#91;</rp><rt>$2</rt><rp>&#93;</rp></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{(.*?)::(.*?)}",replace:'{$1}<span class="uncloze">$2</span>'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=function(){return[{type:"lang",regex:"\n{1,}",replace:"\n\n"}]},e=new Showdown.converter({extensions:[d,b,c]});return function(b){return a(e.makeHtml(b||""))}}]),app.filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),app.filter("dueNow",function(){return function(a){var b=Date.now();return a.filter(function(a){return a.due<b})}}),app.filter("dateDays",function(){var a=Date.now();return function(b){if(!b)return"-";var c=b-a;return 0>c?"now":(c=c/1e3/60,1>c?"soon":(c=c/60/24,1>c?"<1 day":Math.floor(c)+" days"))}}),app.filter("markdown",[function(){var a=new Showdown.converter;return function(b){return a.makeHtml(b||"")}}]);var STATUSALL=-1,STATUSNEW=0,STATUSDUE=1,STATUSDONE=2;app.filter("status",[function(){var a=Date.now();return function(b){return b?null==b.last?STATUSNEW:b.due<=a?STATUSDUE:STATUSDONE:-1}}]),app.filter("statusText",[function(){return function(a){return a==STATUSNEW?"New":a==STATUSDUE?"Due":"Not due"}}]),app.filter("statusFilter",["$filter",function(a){var b=a("status");return function(a,c){return-1==c?a:a.filter(function(a){return b(a)==c})}}]),app.directive("cardBlur",function(){return function(a,b,c){b.bind("blur",function(b){b.relatedTarget||a.$apply(c.cardBlur)})}});