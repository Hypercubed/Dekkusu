"use strict";var DEBUG=!1,DAYS=864e5,app=angular.module("mainApp",["ngRoute","ui.bootstrap","ui.keypress","ui.event","ngSanitize"]);angular.module("mainApp").config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/deckListView.html",controller:"DeckListCtrl"}).when("/:deckId",{templateUrl:"partials/deckView.html",controller:"DeckCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("mainApp").controller("DeckListCtrl",["$scope","cardStorage","$location","$http","$routeParams","$rootScope",function(a,b,c,d){var e=a.decks=b.getDecks();a.getCards=b.getCards,a.listView=!1,a.addDeck=function(){for(var a="Deck",c=1;e.some(function(b){return b.name==a});)c++,a="Deck "+c;e.push({name:a,cards:[]}),b.saveDecks(e)},a.removeDeck=function(c){c>-1&&(a.clearCards(c),e.splice(c,1),b.saveDecks(e))},a.resetCards=function(a){d.get("data/first30.txt").success(function(c){var d=c.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});e[a].cards=d,b.saveDecks(e)})},a.clearCards=function(a){e[a].cards=[],b.saveDecks(e)}}]),angular.module("mainApp").controller("DeckCtrl",["$scope","cardStorage","$location","$http","$routeParams","$rootScope","statusFilterFilter",function(a,b,c,d,e,f,g){function h(){Sscope.decks=b.getDecks(),a.cards=a.decks[a.deckId]}function i(c){b.saveCards(a.deckId,c)}function h(){a.isEditing=!1,a.clozed=!0,a.filter=STATUSDUE,j()}function j(){a.cards=b.getCards(a.deckId),a.index=0,k(a.filter)}function k(b){a.filter=b=b||a.filter,a.filteredCards=g(a.cards,a.filter).sort(function(a,b){return a.due<b.due?-1:a.due>b.due?1:0}),a.goto(a.index)}function l(){b.saveCards(a.deckId,a.cards)}function m(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=o.selectionStart,c=o.selectionEnd;if(b!==c)return o.value.slice(b,c).trim()}return null}a.deckId=e.deckId||0;var n=a.decks=b.getDecks();a.deck=n[a.deckId],a.isEditing=!1,a.editDeck=function(b){a.isEditing=arguments.length>0?b:!a.isEditing},a.gotoDeck=function(a){c.path("/"+a)},a.resetCards=function(){d.get("data/first30.txt").success(function(b){var c=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}});a.cards=c,i(c)})},a.clearCards=function(){a.cards=[],i([])},a.$watch("deck.name",function(){b.saveDecks(n)}),a.deckId=e.deckId||0;var o=angular.element(".cardEditor")[0];a.location=c,a.search=c.search(),a.$watch(location.path,function(){h()},!0),a.$on("handleBroadcast",function(){console.log("handleBroadcast"),h()}),a.blurCallback=function(){console.log("blur")},a.goto=function(b){"object"==typeof b&&(b=a.filteredCards.indexOf(b)),b>a.filteredCards.length&&(b=a.filteredCards.length),0>b&&(a.index=0),a.index=b,a.card=a.filteredCards[a.index]},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.wrap=function(b,c){window.getSelection();var d=o.selectionStart,e=o.selectionEnd,f=a.card.text;a.card.text=f.slice(0,d)+b+f.slice(d,e)+c+f.slice(e),setTimeout(function(){o.selectionStart=d+b.length,o.selectionEnd=e+b.length},100)},a.flip=function(){a.clozed=!a.clozed},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.up=function(){a.card.last=Date.now(),a.card.due-a.card.last<=0&&(a.card.interval=a.card.interval>0?2*a.card.interval:1),a.card.due=a.card.last+a.card.interval*DAYS,a.clozed=!0,k()},a.down=function(){a.card.due=a.card.last=Date.now()-5,a.card.interval=0,a.clozed=!0,k()},a.prev=function(){var b=a.index>0?a.index:a.filteredCards.length;a.goto(b-1)},a.next=function(){var b=a.index<a.filteredCards.length-1?a.index+1:0;a.goto(b)},a.add=function(){var b=m(),c={};c.text=b||"",c.due=c.due||Date.now(),c.interval=c.interval||0,a.cards.push(c),a.filteredCards=a.cards,a.goto(c),a.isEditing=!0},a.deleteCard=function(){var b=a.cards.indexOf(a.card);a.cards.splice(b,1),a.goto(a.index)},a.reset=function(){console.log("reset"),d.get("data/first30.txt").success(function(b){console.log("data",b),a.cards=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}}),l(),j()})},a.clear=function(){a.cards=[],l(),j()},h(),a.$watch("card.text",function(a,b){a!=b&&l()}),a.$watch("card.due",function(a,b){a!=b&&l()}),a.$watch("filter",function(a,b){a!=b&&k(a)})}]),app.filter("formatCard",["$sanitize",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rp>&#91;</rp><rt>$2</rt><rp>&#93;</rp></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{(.*?)::(.*?)}",replace:'{$1}<span class="uncloze">$2</span>'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=function(){return[{type:"lang",regex:"\n{1,}",replace:"\n\n"}]},e=new Showdown.converter({extensions:[d,b,c]});return function(b){return a(e.makeHtml(b||""))}}]),app.filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),app.filter("dueNow",function(){return function(a){var b=Date.now();return a.filter(function(a){return a.due<b})}}),app.filter("dateDays",function(){var a=Date.now();return function(b){if(!b)return"-";var c=b-a;return 0>c?"now":(c=c/1e3/60,1>c?"soon":(c=c/60/24,1>c?"<1 day":Math.floor(c)+" days"))}}),app.filter("markdown",[function(){var a=new Showdown.converter;return function(b){return a.makeHtml(b||"")}}]);var STATUSALL=-1,STATUSNEW=0,STATUSDUE=1,STATUSDONE=2;app.filter("status",[function(){var a=Date.now();return function(b){return b?null==b.last?STATUSNEW:b.due<=a?STATUSDUE:STATUSDONE:-1}}]),app.filter("statusText",[function(){return function(a){return a==STATUSNEW?"New":a==STATUSDUE?"Due":"Not due"}}]),app.filter("statusFilter",["$filter",function(a){var b=a("status");return function(a,c){return-1==c?a:a.filter(function(a){return b(a)==c})}}]),app.factory("cardStorage",["$http",function(){var a="cards-app",b={};return b.getDecks=function(){var b=localStorage.getItem(a+"-decks");return b?JSON.parse(b):[{name:"Default",cards:[]}]},b.saveDecks=function(b){localStorage.setItem(a+"-decks",JSON.stringify(b))},b.getCards=function(a){var a=a||0,c=b.getDecks();return c[a].cards||[]},b.saveCards=function(a,c){var d=b.getDecks();d.cards=c,b.saveDecks(d)},b}]),app.controller("NavCtrl",["$scope",function(a){a.collapse=!0}]),app.directive("cardBlur",function(){return function(a,b,c){b.bind("blur",function(b){b.relatedTarget||a.$apply(c.cardBlur)})}});