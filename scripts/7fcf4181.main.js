"use strict";var DEBUG=!1,app=angular.module("mainApp",["ui.bootstrap","ui.keypress","ui.event"]);app.controller("CardCtrl",["$scope","cardStorage","$http","$filter",function(a,b,c,d){function e(){a.cards=b.getCards(),i()}function f(){console.log("saving to local storage"),b.saveCards(a.cards)}function g(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=k.selectionStart,c=k.selectionEnd;if(b!==c)return k.value.slice(b,c).trim()}return null}function h(b,c){window.getSelection();var d=k.selectionStart,e=k.selectionEnd,f=a.card.text;a.card.text=f.slice(0,d)+b+f.slice(d,e)+c+f.slice(e),setTimeout(function(){k.selectionStart=d+b.length,k.selectionEnd=e+b.length},100)}function i(){a.clozed=!0;var b=d("firstDueIndex")(a.cards);a.goto(b)}function j(b){return b=b||{},b.text=b.text||"",b.due=b.due||new Date,b.interval=b.interval||0,a.cards.push(b)-1}var k=angular.element(".cardEditor")[0];angular.element(".cardEditor").on("blur",function(b){b.relatedTarget||a.$apply(function(){console.log("blur"),a.edit(!1)})}),a.isEditing=!1,a.clozed=!0,a.blurCallback=function(){console.log("blur")},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.flip=function(){a.clozed=!a.clozed,a.isEditing=!1},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.up=function(){var b=a.interval>0?2*a.interval:1,c=(new Date).getDate()+b;a.card.interval=b,a.card.due.setDate(c),i()},a.down=function(){a.card.due=new Date,a.card.interval=0,i()},a.prev=function(){var b=a.index>0?a.index:a.cards.length;a.goto(b-1)},a.next=function(){var b=a.index<a.cards.length-1?a.index+1:0;a.goto(b)},a.goto=function(b){b>a.cards.length&&(b=a.cards.length),0>b&&(a.index=0),a.index=b,a.card=a.cards[a.index]},a.b1=function(){h("{","}")},a.b2=function(){h("{{","}}")},a.add=function(){var b=g(),c=j({text:b});a.goto(c),a.isEditing=!0},a.deleteCard=function(){a.cards.splice(a.index,1),a.goto(a.index)},a.reset=function(){c.get("data/first30.txt").success(function(b){a.cards=b.split("\n").filter(function(a){return""!=a}).map(function(a){return a=a.replace(/\\n/g,"\n"),{text:a,due:new Date,interval:0}}),f(),e()})},a.clear=function(){a.cards=[],f(),e()},a.dueNow=function(a){var b=new Date;return a.due<b},e(),a.$watch("card.text",function(a,b){console.log("card.text changed",a,b),a!=b&&f()}),a.$watch("card.due",function(a,b){console.log("card.due changed",a,b),a!=b&&f()})}]),app.filter("formatCard",["$sce",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rt>$2</rt></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=new Showdown.converter({extensions:[b,c]});return function(b){return a.trustAsHtml(d.makeHtml(b||""))}}]),app.filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),app.filter("dueNow",function(){return function(a){var b=new Date;return a.filter(function(a){return a.due<b})}}),app.filter("markdown",["$sce",function(a){var b=new Showdown.converter;return function(c){return a.trustAsHtml(b.makeHtml(c||""))}}]),app.factory("cardStorage",["$http",function(){var a="cards-app-cards",b={};return b.getCards=function(){var b=localStorage.getItem(a);if(b){var c=JSON.parse(b);return c.forEach(function(a){var b=Date.parse(a.due);a.due=new Date(b)}),c}return[]},b.saveCards=function(b){localStorage.setItem(a,JSON.stringify(b))},b}]);