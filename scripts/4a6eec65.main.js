"use strict";var DEBUG=!1,app=angular.module("mainApp",["ui.bootstrap","ui.keypress","ui.event","ngSanitize"]);app.controller("CardCtrl",["$scope","cardStorage","$http","$filter","$location",function(a,b,c,d,e){function f(){a.isEditing=!1,a.clozed=!0,"/all"==e.path()&&(a.filter=0),a.filter="/soon"==e.path()?1:0,g()}function g(){a.cards=b.getCards(),a.index=0,h(a.filter)}function h(b){a.filter=b=b||a.filter;var c=(new Date).getDate();a.filteredCards=a.cards.filter(function(a){return 0>b?!0:a.due.getDate()-c<=b}).sort(function(a,b){return a.due<b.due?-1:a.due>b.due?1:0}),a.goto(a.index)}function i(){b.saveCards(a.cards)}function j(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=l.selectionStart,c=l.selectionEnd;if(b!==c)return l.value.slice(b,c).trim()}return null}function k(b,c){window.getSelection();var d=l.selectionStart,e=l.selectionEnd,f=a.card.text;a.card.text=f.slice(0,d)+b+f.slice(d,e)+c+f.slice(e),setTimeout(function(){l.selectionStart=d+b.length,l.selectionEnd=e+b.length},100)}console.log(e.path());var l=angular.element(".cardEditor")[0];a.blurCallback=function(){console.log("blur")},a.goto=function(b){"object"==typeof b&&(b=a.filteredCards.indexOf(b)),b>a.filteredCards.length&&(b=a.filteredCards.length),0>b&&(a.index=0),a.index=b,a.card=a.filteredCards[a.index]},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.flip=function(){a.clozed=!a.clozed,a.isEditing=!1},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.up=function(){var b=a.card.interval>0?2*a.card.interval:1,c=(new Date).getDate()+b;a.card.interval=b,a.card.due.setDate(c),a.clozed=!0,h()},a.down=function(){a.card.due=new Date,a.card.interval=0,a.clozed=!0,h()},a.prev=function(){var b=a.index>0?a.index:a.filteredCards.length;a.goto(b-1)},a.next=function(){var b=a.index<a.filteredCards.length-1?a.index+1:0;a.goto(b)},a.b1=function(){k("{","}")},a.b2=function(){k("{{","}}")},a.add=function(){var b=j(),c={};c.text=b||"",c.due=c.due||new Date,c.interval=c.interval||0,a.cards.push(c),a.filteredCards=a.cards,a.goto(c),a.isEditing=!0},a.deleteCard=function(){var b=a.cards.indexOf(a.card);a.cards.splice(b,1),a.goto(a.index)},a.reset=function(){c.get("data/first30.txt").success(function(b){a.cards=b.split("\n").filter(function(a){return""!=a}).map(function(a){return a=a.replace(/\\n/g,"\n"),{text:a,due:new Date,interval:0}}),i(),g()})},a.clear=function(){a.cards=[],i(),g()},a.dueNow=function(a){var b=new Date;return a.due<b},f(),a.$watch("card.text",function(a,b){console.log("card.text changed",a,b),a!=b&&i()}),a.$watch("card.due",function(a,b){console.log("card.due changed",a,b),a!=b&&i()}),a.$watch("filter",function(a,b){console.log("filter changed",a,b),a!=b&&h(a)})}]),app.filter("formatCard",["$sanitize",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rp>&#91;</rp><rt>$2</rt><rp>&#93;</rp></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=new Showdown.converter({extensions:[b,c]});return function(b){return a(d.makeHtml(b||""))}}]),app.filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),app.filter("dueNow",function(){return function(a){var b=new Date;return a.filter(function(a){return a.due<b})}}),app.filter("dateDays",function(){var a=new Date;return function(b){var c=b-a;return 0>c?"now":(c=c/1e3/60,1>c?"soon":(c=c/60/24,1>c?"<1 day":Math.floor(c)+" days"))}}),app.filter("markdown",[function(){var a=new Showdown.converter;return function(b){return a.makeHtml(b||"")}}]),app.factory("cardStorage",["$http",function(){var a="cards-app-cards",b={};return b.getCards=function(){var b=localStorage.getItem(a);if(b){var c=JSON.parse(b);return c.forEach(function(a){var b=Date.parse(a.due);a.due=new Date(b)}),c}return[]},b.saveCards=function(b){localStorage.setItem(a,JSON.stringify(b))},b}]),app.directive("cardBlur",function(){return function(a,b,c){b.bind("blur",function(b){b.relatedTarget||a.$apply(c.cardBlur)})}});