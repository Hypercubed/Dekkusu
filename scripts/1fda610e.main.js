"use strict";var DEBUG=!1,app=angular.module("mainApp",["ui.bootstrap"]);app.controller("CardCtrl",["$scope","cardStorage","$http",function(a,b,c){function d(){a.cards=b.getCards(),g(),a.index=0,a.card=a.cards[a.index],a.due=h()}function e(){console.log("saving to local storage"),b.saveCards(a.cards)}function f(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=k.selectionStart,c=k.selectionEnd;if(b!==c)return k.value.slice(b,c).trim()}return null}function g(){console.log("sort"),a.cards=a.cards.sort(function(a,b){return a=new Date(a.due),b=new Date(b.due),b>a?-1:a>b?1:0})}function h(){var b=new Date;return a.cards.filter(function(a){return a.due<b}).length}function i(){a.clozed=!0,g(),a.goto(0)}function j(b){return b=b||{},b.text=b.text||"",b.due=b.due||new Date,b.interval=b.interval||0,a.cards.push(b)-1}var k=angular.element(".cardEditor")[0];a.isEditing=!1,a.clozed=!0,d(),a.$watch("card.text",function(a,b){console.log("card.text changed",a,b),a!=b&&e()}),a.$watch("card.due",function(b,c){console.log("card.due changed",b,c),b!=c&&(e(),a.due=h())}),a.formattedCard=function(){return a.card.text.replace(/{{(.*?)::(.*?)}}/g,'&#91;{$1}<span class="uncloze">$2</span>&#93;').replace(/{{(.*?)}}/g,'&#91;{$1}<span class="uncloze">...</span>&#93;').replace(/{(.*?)}/g,'<span class="cloze">$1</span>').replace(/\n/g,"<br />")},a.flip=function(){a.clozed=!a.clozed,a.isEditing=!1},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.up=function(){var b=a.interval>0?2*a.interval:1,c=(new Date).getDate()+b;a.card.interval=b,a.card.due.setDate(c),a.due=h(),i()},a.down=function(){a.card.due=new Date,a.card.interval=0,a.due=h(),i()},a.prev=function(){var b=a.index>0?a.index-1:a.cards.length;a.goto(b)},a.next=function(){var b=a.index<a.cards.length-1?a.index+1:0;a.goto(b)},a.goto=function(b){b>a.cards.length&&(b=a.cards.length),0>b&&(a.index=0),a.index=b,a.card=a.cards[a.index]},a.b1=function(){var b=f();a.card.text=a.card.text.replace(b,"{"+b+"}")},a.b2=function(){var b=f();a.card.text=a.card.text.replace(b,"{{"+b+"}}")},a.add=function(){var b=f(),c=j({text:b});a.goto(c),a.isEditing=!0},a.deleteCard=function(){a.cards.splice(a.index,1),a.goto(a.index)},a.reset=function(){c.get("data/first30.txt").success(function(b){var c=b.split("\n").map(function(a){return{text:a,due:new Date,interval:0}});a.cards=c,a.index=0,a.card=a.cards[a.index],a.due=h()})}}]),app.factory("cardStorage",["$http",function(){var a="cards-app-cards",b={};return b.getCards=function(){var b=localStorage.getItem(a);if(b){var c=JSON.parse(b);return c.forEach(function(a){var b=Date.parse(a.due);a.due=new Date(b)}),c}return[]},b.saveCards=function(b){localStorage.setItem(a,JSON.stringify(b))},b}]);