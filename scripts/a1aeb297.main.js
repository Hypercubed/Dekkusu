"use strict";var DEBUG=!1,DAYS=864e5,app=angular.module("mainApp",["ui.bootstrap","ui.keypress","ui.event","ngSanitize"]);app.controller("CardCtrl",["$scope","cardStorage","$http","$filter","$location","statusFilterFilter",function(a,b,c,d,e,f){function g(){a.isEditing=!1,a.clozed=!0,a.filter="/due"==e.path()?STATUSDUE:"/all"==e.path()?-1:"/done"==e.path()?STATUSDONE:"/new"==e.path()?STATUSNEW:STATUSDUE,h()}function h(){a.cards=b.getCards(),a.index=0,i(a.filter)}function i(b){a.filter=b=b||a.filter,a.filteredCards=f(a.cards,a.filter).sort(function(a,b){return a.due<b.due?-1:a.due>b.due?1:0}),a.goto(a.index)}function j(){b.saveCards(a.cards)}function k(){var a=window.getSelection();if("Range"==a.type)return DEBUG&&console.log("Window selection"),a.toString().trim();if("None"==a.type){DEBUG&&console.log("Input selection");var b=l.selectionStart,c=l.selectionEnd;if(b!==c)return l.value.slice(b,c).trim()}return null}console.log(e.path());var l=angular.element(".cardEditor")[0];a.blurCallback=function(){console.log("blur")},a.goto=function(b){"object"==typeof b&&(b=a.filteredCards.indexOf(b)),b>a.filteredCards.length&&(b=a.filteredCards.length),0>b&&(a.index=0),a.index=b,a.card=a.filteredCards[a.index]},a.keypressCallback=function(b){console.log(b.keyCode),32==b.keyCode?(a.flip(),b.preventDefault()):13==b.keyCode?a.edit():37==b.keyCode?a.prev():39==b.keyCode?a.next():38!=b.keyCode||a.clozed?40!=b.keyCode||a.clozed||a.down():a.up()},a.wrap=function(b,c){window.getSelection();var d=l.selectionStart,e=l.selectionEnd,f=a.card.text;a.card.text=f.slice(0,d)+b+f.slice(d,e)+c+f.slice(e),setTimeout(function(){l.selectionStart=d+b.length,l.selectionEnd=e+b.length},100)},a.flip=function(){a.clozed=!a.clozed,a.isEditing=!1},a.edit=function(b){arguments.length<1&&(b=!a.isEditing),a.isEditing=b},a.up=function(){a.card.last=Date.now(),a.card.due-a.card.last<=0&&(a.card.interval=a.card.interval>0?2*a.card.interval:1),a.card.due=a.card.last+a.card.interval*DAYS,a.clozed=!0,i()},a.down=function(){a.card.due=a.card.last=Date.now()-5,a.card.interval=0,a.clozed=!0,i()},a.prev=function(){var b=a.index>0?a.index:a.filteredCards.length;a.goto(b-1)},a.next=function(){var b=a.index<a.filteredCards.length-1?a.index+1:0;a.goto(b)},a.add=function(){var b=k(),c={};c.text=b||"",c.due=c.due||Date.now(),c.interval=c.interval||0,a.cards.push(c),a.filteredCards=a.cards,a.goto(c),a.isEditing=!0},a.deleteCard=function(){var b=a.cards.indexOf(a.card);a.cards.splice(b,1),a.goto(a.index)},a.reset=function(){c.get("data/first30.txt").success(function(b){a.cards=b.split("\n").filter(function(a){return""!=a}).map(function(a){a=a.replace(/\\n/g,"\n");var b=Date.now();return{text:a,due:b,last:null,interval:0}}),j(),h()})},a.clear=function(){a.cards=[],j(),h()},g(),a.$watch("card.text",function(a,b){console.log("card.text changed",a,b),a!=b&&j()}),a.$watch("card.due",function(a,b){console.log("card.due changed",a,b),a!=b&&j()}),a.$watch("filter",function(a,b){console.log("filter changed",a,b),a!=b&&i(a)})}]),app.filter("formatCard",["$sanitize",function(a){var b=function(){return[{type:"lang",regex:"(\\S*)\\{\\[(.*?)\\]\\}",replace:"$1[{$2}]"},{type:"lang",regex:"(\\S*)\\[(.*?)\\]",replace:"<ruby><rb>$1</rb><rp>&#91;</rp><rt>$2</rt><rp>&#93;</rp></ruby>"}]},c=function(){return[{type:"lang",regex:"{{(.*?)::(.*?)}}",replace:'&#91;{$1}<span class="uncloze">$2</span>&#93;'},{type:"lang",regex:"{(.*?)::(.*?)}",replace:'{$1}<span class="uncloze">$2</span>'},{type:"lang",regex:"{{(.*?)}}",replace:'&#91;{$1}<span class="uncloze">...</span>&#93;'},{type:"lang",regex:"{(.*?)}",replace:'<span class="cloze">$1</span>'}]},d=function(){return[{type:"lang",regex:"\n{1,}",replace:"\n\n"}]},e=new Showdown.converter({extensions:[d,b,c]});return function(b){return a(e.makeHtml(b||""))}}]),app.filter("firstDueIndex",function(){return function(a){var b=void 0;if(a)for(var c in a)(void 0==b||a[c].due<a[b].due)&&(b=c);return+b}}),app.filter("dueNow",function(){return function(a){var b=Date.now();return a.filter(function(a){return a.due<b})}}),app.filter("dateDays",function(){var a=Date.now();return function(b){if(!b)return"-";var c=b-a;return 0>c?"now":(c=c/1e3/60,1>c?"soon":(c=c/60/24,1>c?"<1 day":Math.floor(c)+" days"))}}),app.filter("markdown",[function(){var a=new Showdown.converter;return function(b){return a.makeHtml(b||"")}}]);var STATUSALL=-1,STATUSNEW=0,STATUSDUE=1,STATUSDONE=2;app.filter("status",[function(){var a=Date.now();return function(b){return b?null==b.last?STATUSNEW:b.due<a?STATUSDUE:STATUSDONE:-1}}]),app.filter("statusText",[function(){return function(a){return a==STATUSNEW?"New":a==STATUSDUE?"Due":"Not due"}}]),app.filter("statusFilter",["$filter",function(a){var b=a("status");return function(a,c){return-1==c?a:a.filter(function(a){return b(a)==c})}}]),app.factory("cardStorage",["$http",function(){var a="cards-app-cards",b={};return b.getCards=function(){var b=localStorage.getItem(a);if(b){var c=JSON.parse(b);return c}return[]},b.saveCards=function(b){localStorage.setItem(a,JSON.stringify(b))},b}]),app.directive("cardBlur",function(){return function(a,b,c){b.bind("blur",function(b){b.relatedTarget||a.$apply(c.cardBlur)})}});